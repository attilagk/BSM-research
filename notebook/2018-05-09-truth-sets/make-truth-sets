#! /usr/bin/env bash

# Make variant type-specific truth sets from CEPH/Utah grandparent VCFs.
#
# Inputs
# inputdir: the directory with the 4 grandparental VCFs
# vartype: [snps|indels|...]
#
# Outputs
# The [snps|indels|...] directory---in the same directory as
# inputdir---contains the following files and directories:
# NA12889.vcf.gz,...,NA12892.vcf.gz: the 4 call sets, i.e. grandparental VCFs filtered for vartype
# NA12889.vcf.gz.tbi,...,NA12892.vcf.gz.tbi: the corresponding indices
# variant-alleles: directory for variants distinguished by positions AND alleles
# variant-positions: directory for variants distinguished by ONLY positions
# {variant-alleles,variant-alleles}/{0001, 0011,...,1111}: the 2^4 - 1 = 15 partitions from the 4 call sets

usage="`basename $0` inputdir [snps|indels|mnps|other]"
if test $# -ne 2; then
    echo $usage; exit 1
fi

inputdir=$1
vartype=$2
outputdir="`dirname ${inputdir}`/`basename ${inputdir}`-${vartype}"

# map of chromosome names: from "Illumina platinum format" to "BSMN format"
touch chr-map
chrmap=`realpath chr-map`
for s in {1..22} X Y; do echo -e "chr$s\t$s"; done > $chrmap
echo -e "chrM\tMT" >> $chrmap

#nthreads="$((`nproc` - 1))" # only minimal speedup
nthreads=0
gparents="NA12889 NA12890 NA12891 NA12892"

# filter for the selected variant type
if test ! -d $outputdir; then
    mkdir $outputdir
    for gp in $gparents; do
        gpvcf="$outputdir/$gp.vcf.gz"
        bcftools annotate --rename-chrs $chrmap --output-type z \
            --threads $nthreads \
            $inputdir/${gp}_S1.vcf.gz |
        # keep only chromosomal contigs
        bcftools view --types $vartype --output-type z \
            --output-file $gpvcf \
            --targets 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,X,Y,MT \
            --threads $nthreads -
        bcftools index --tbi $gpvcf
    done
fi
rm $chrmap
