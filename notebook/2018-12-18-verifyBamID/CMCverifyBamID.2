#! /usr/bin/env bash

bam=`realpath $1`
opts=$2
vcf=/projects/bsm/attila/results/2018-12-18-verifyBamID/CMC-preimputed.vcf.gz
metadata=/projects/bsm/attila/results/2018-12-18-verifyBamID/CMC_Human_SNP_mergedMetadata.csv

IndIDfromBAMname=`basename $bam .bam`

IndIDfromBAMheader="$(samtools view -H $bam |
    sed -n '/^@RG/ { s/^.*SM:\(\(MSSM\|PITT\)_\?\([[:digit:]]\+\)_\(NeuN_pl\|NeuN_mn\|muscle\)\).*$/\2_\3_\4/; p }' |
    sort -u)"

set "$IndIDfromBAMheader"
if ! test $# -eq 1; then
    echo "$bam contains multiple samples: $IndIDfromBAMheader. Exiting..."
    exit 1
fi

if ! test $IndIDfromBAMname = $IndIDfromBAMheader; then
    echo "Sample name from BAM file name $IndIDfromBAMname doesn't match with sample name from BAM header $IndIDfromBAMheader. Exiting..."
    exit 1
fi

IDmap=`tempfile`
IndIDcol=$(head -n1 $metadata | tr ',' '\n' | sed '/Individual_ID/ q' | wc -l)
#DissecID=$(head -n1 $metadata | tr ',' '\n' | sed '/Institution_Dissection_ID/ q' | wc -l)
GTSMIDcol=$(head -n1 $metadata | tr ',' '\n' | sed '/SNP_report:Genotyping_Sample_ID/ q' | wc -l)
cut -d, -f$IndIDcol,$GTSMIDcol $metadata |
    tr -d '"' |
    sed 's/^CMC_//; s/,/,0_/; /,0_NA/ s/0_NA/NA/' > $IDmap

indivID=$(echo $IndIDfromBAMname | sed 's/_\(NeuN_pl\|NeuN_mn\|muscle\)//')
GTSMID=$(sed -n "/^$indivID,/ { s///; p }" $IDmap)

echo $GTSMID

verifyBamID --vcf $vcf --bam $bam --out $IndIDfromBAMname --ignoreRG \
    --smID $GTSMID $opts
